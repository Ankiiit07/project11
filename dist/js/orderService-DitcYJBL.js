var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,i=(t,r,s)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,o=(e,t)=>{for(var r in t||(t={}))n.call(t,r)&&i(e,r,t[r]);if(s)for(var r of s(t))a.call(t,r)&&i(e,r,t[r]);return e},d=(e,s)=>t(e,r(s));import{e as c}from"./index-DMGNuXZ5.js";const l=new class{constructor(){this.SYNC_KEY="cafe_at_once_sync_events",this.LAST_UPDATE_KEY="cafe_at_once_last_update",this.MAX_EVENTS=100,this.listeners=new Map,this.isInitialized=!1,this.lastProcessedTimestamp=0,this.checkInterval=null,this.initialize()}initialize(){this.isInitialized||(window.addEventListener("storage",this.handleStorageEvent.bind(this)),window.addEventListener("focus",this.handleFocusEvent.bind(this)),this.checkInterval=setInterval(()=>{this.checkForUpdates()},2e3),this.isInitialized=!0)}handleStorageEvent(e){e.key!==this.SYNC_KEY&&e.key!==this.LAST_UPDATE_KEY||this.checkForUpdates()}handleFocusEvent(){this.checkForUpdates()}checkForUpdates(){const e=this.getLastUpdateTimestamp();e>this.lastProcessedTimestamp&&(this.processAllEvents(),this.lastProcessedTimestamp=e)}processAllEvents(){this.getSyncEvents().filter(e=>e.timestamp>this.lastProcessedTimestamp).forEach(e=>{this.processSyncEvent(e)})}processSyncEvent(e){(this.listeners.get(e.type)||[]).forEach(t=>{try{t(e.data)}catch(r){}})}getSyncEvents(){try{const e=localStorage.getItem(this.SYNC_KEY);return e?JSON.parse(e):[]}catch(e){return[]}}setSyncEvents(e){try{localStorage.setItem(this.SYNC_KEY,JSON.stringify(e)),localStorage.setItem(this.LAST_UPDATE_KEY,Date.now().toString())}catch(t){}}getLastUpdateTimestamp(){try{const e=localStorage.getItem(this.LAST_UPDATE_KEY);return e?parseInt(e):0}catch(e){return 0}}cleanupOldEvents(){const e=this.getSyncEvents(),t=Date.now()-36e5,r=e.filter(e=>e.timestamp>t);r.length!==e.length&&this.setSyncEvents(r)}broadcastEvent(e,t){const r={type:e,data:t,timestamp:Date.now(),source:`tab_${Math.random().toString(36).substring(2,15)}`},s=this.getSyncEvents();s.push(r),s.length>this.MAX_EVENTS&&s.splice(0,s.length-this.MAX_EVENTS),this.setSyncEvents(s),this.processSyncEvent(r)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){const r=this.listeners.get(e);if(r){const e=r.indexOf(t);e>-1&&r.splice(e,1)}}forceSync(){this.checkForUpdates()}getSyncStatus(){const e=this.getSyncEvents(),t=this.getLastUpdateTimestamp();return{totalEvents:e.length,lastProcessed:new Date(this.lastProcessedTimestamp),lastUpdate:new Date(t),pendingEvents:e.filter(e=>e.timestamp>this.lastProcessedTimestamp).length,isInitialized:this.isInitialized}}clearSyncData(){localStorage.removeItem(this.SYNC_KEY),localStorage.removeItem(this.LAST_UPDATE_KEY),this.lastProcessedTimestamp=0,this.listeners.clear()}destroy(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),this.listeners.clear(),this.isInitialized=!1}testSync(){const e={message:"Test sync from "+(new Date).toLocaleTimeString(),tabId:Math.random().toString(36).substring(2,15)};return this.broadcastEvent("order_created",e),e}},h={orderCreated:e=>{l.broadcastEvent("order_created",e)},orderUpdated:e=>{l.broadcastEvent("order_updated",e)},orderDeleted:e=>{l.broadcastEvent("order_deleted",{orderId:e})},newsletterSubscribed:e=>{l.broadcastEvent("newsletter_subscribed",{email:e})},dataCleared:()=>{l.broadcastEvent("data_cleared",{timestamp:Date.now()})},onOrderCreated:e=>l.on("order_created",e),onOrderUpdated:e=>l.on("order_updated",e),onOrderDeleted:e=>l.on("order_deleted",e),onNewsletterSubscribed:e=>l.on("newsletter_subscribed",e),onDataCleared:e=>l.on("data_cleared",e),forceSync:()=>l.forceSync(),getStatus:()=>l.getSyncStatus(),clearData:()=>l.clearSyncData(),destroy:()=>l.destroy(),test:()=>l.testSync()};"undefined"!=typeof window&&(window.testCrossBrowserSync=()=>h.test());const g=new class{constructor(){this.STORAGE_KEY="cafe_at_once_orders",this.CUSTOMER_KEY="cafe_at_once_customer",this.setupSyncListeners()}setupSyncListeners(){h.onOrderCreated(e=>{this.notifyOrderChange()}),h.onOrderUpdated(e=>{this.updateOrderFromSync(e)}),h.onOrderDeleted(e=>{this.removeOrderFromSync(e.orderId)}),h.onDataCleared(()=>{this.clearAllOrders()})}notifyOrderChange(){window.dispatchEvent(new CustomEvent("ordersChanged"))}updateOrderFromSync(e){const t=this.getOrders(),r=t.findIndex(t=>t.id===e.id);-1!==r&&(t[r]=o(o({},t[r]),e),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),this.notifyOrderChange())}removeOrderFromSync(e){const t=this.getOrders(),r=t.filter(t=>t.id!==e);r.length!==t.length&&(localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r)),this.notifyOrderChange())}generateOrderId(){return`order_${Date.now()}_${Math.random().toString(36).substring(2,15)}`}getOrders(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return[]}}getOrderById(e){return this.getOrders().find(t=>t.id===e)||null}createOrder(e,t,r,s,n,a){const i={id:this.generateOrderId(),customerInfo:t,items:e.map(e=>({id:e.id,name:e.name,price:e.price,quantity:e.quantity,image:e.image,type:e.type})),subtotal:s,shipping:n,tax:a,total:s+n+a,paymentInfo:r,status:"pending",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},o=this.getOrders();o.push(i),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(o)),this.saveCustomerInfo(t),h.orderCreated(i);try{c.sendOrderNotification({orderNumber:i.id,customerName:`${t.firstName} ${t.lastName}`,customerEmail:t.email,customerPhone:t.phone,items:i.items,total:i.total,paymentMethod:r.method,shippingAddress:{street:t.address,city:t.city,state:t.state,zipCode:t.zipCode,country:t.country}})}catch(d){}return this.notifyOrderChange(),i}updateOrderStatus(e,t,r){const s=this.getOrders(),n=s.findIndex(t=>t.id===e);if(-1===n)return null;const a=d(o({},s[n]),{status:t,updatedAt:(new Date).toISOString()});return r&&(a.trackingNumber=r),s[n]=a,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)),h.orderUpdated(a),this.notifyOrderChange(),a}updatePaymentInfo(e,t){const r=this.getOrders(),s=r.findIndex(t=>t.id===e);if(-1===s)return null;const n=d(o({},r[s]),{paymentInfo:o(o({},r[s].paymentInfo),t),updatedAt:(new Date).toISOString()});return r[s]=n,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r)),h.orderUpdated(n),this.notifyOrderChange(),n}getOrdersByCustomer(e){return this.getOrders().filter(t=>t.customerInfo.email===e)}getRecentOrders(e=10){return this.getOrders().sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(0,e)}getOrdersByStatus(e){return this.getOrders().filter(t=>t.status===e)}deleteOrder(e){const t=this.getOrders(),r=t.filter(t=>t.id!==e);return r.length!==t.length&&(localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r)),h.orderDeleted(e),this.notifyOrderChange(),!0)}saveCustomerInfo(e){try{localStorage.setItem(this.CUSTOMER_KEY,JSON.stringify(e))}catch(t){}}getCustomerInfo(){try{const e=localStorage.getItem(this.CUSTOMER_KEY);return e?JSON.parse(e):null}catch(e){return null}}clearAllOrders(){localStorage.removeItem(this.STORAGE_KEY),h.dataCleared(),this.notifyOrderChange()}exportOrders(){const e=this.getOrders();return JSON.stringify(e,null,2)}importOrders(e){try{const t=JSON.parse(e);return!!Array.isArray(t)&&(localStorage.setItem(this.STORAGE_KEY,e),h.dataCleared(),this.notifyOrderChange(),!0)}catch(t){return!1}}getOrderStats(){const e=this.getOrders(),t=e.length,r=e.reduce((e,t)=>e+t.total,0);return{totalOrders:t,totalRevenue:r,pendingOrders:e.filter(e=>"pending"===e.status).length,completedOrders:e.filter(e=>"delivered"===e.status).length,averageOrderValue:t>0?r/t:0}}searchOrders(e){const t=this.getOrders(),r=e.toLowerCase();return t.filter(e=>e.id.toLowerCase().includes(r)||e.customerInfo.firstName.toLowerCase().includes(r)||e.customerInfo.lastName.toLowerCase().includes(r)||e.customerInfo.email.toLowerCase().includes(r)||e.items.some(e=>e.name.toLowerCase().includes(r)))}refreshOrders(){this.notifyOrderChange()}getSyncStatus(){return h.getStatus()}};export{g as o,h as s};
